<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My first three.js app</title>
    <link rel="stylesheet" href="css/main.css">

    <httpProtocol>
        <customHeaders>
            <add name="Access-Control-Allow-Origin" value="*" />
        </customHeaders>
    </httpProtocol>

</head>
<body>



    <script type="module">

        //import  THREE from 'https://cdn.skypack.dev/three.js'; => Does not work properly, made scene not change and zoom not work!

        import * as THREE from 'https://unpkg.com/three/build/three.module.js'

        import { OrbitControls } from 'https://cdn.skypack.dev/three@0.128.0/examples/jsm/controls/OrbitControls.js'

        let camera, scene, renderer;
    
        let geometry, material, mesh,controls;

        const Http = new XMLHttpRequest();

        const url='https://localhost:44360/DataNodes/GetLatestNodeCollection';

        init();
        animation();

        function init() {
  
        scene = new THREE.Scene();
        scene.background = new THREE.Color(  0xcccccc );
		//scene.fog = new THREE.Fog( 0xa0a0a0, 10, 50 );


        camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 1, 1000 );
        camera.position.set( 26, - 40, 5 );

        initRenderer();

        initControls();

        //createTorus();

        initLights();

    
		const grid = new THREE.GridHelper( 2000, 20, 0x000000, 0x000000 );
		grid.material.opacity = 0.2;
		grid.material.transparent = true;
		scene.add( grid );
		
        getGeometryFromBimorphApi();

       window.addEventListener( 'resize', resize );

    }

    function getGeometryFromBimorphApi(){

        Http.open("GET", url);
        Http.send();

    }

    Http.onreadystatechange = function(){

        if(this.readyState == 4 && this.status ==200){

            var json = Http.responseText;

            var nodeCollection = JSON.parse(json);

            var nodes = nodeCollection.nodes;

            if(nodes.length==1){

               var node =  nodes[0]

               var valueJson =  node.value;

               var value = JSON.parse(valueJson);

               var vertices = value.Vertices;

               var faces = value.Faces;


              // var arrayThreeVecs = [vertices.length]; 

                const geometry = new THREE.BufferGeometry();
                const indices = [];
				const bufferGeoVertices = [];

               for (var i = 0; i < vertices.length; i++) {

                    var vertArray = vertices[i];

                    //var threeVec = new THREE.Vector3(vertArray[0],vertArray[1],vertArray[2])  
                    
                    bufferGeoVertices.push(vertArray[0],vertArray[1],vertArray[2]);
                }

                for (let i = 0; i < faces.length; i++) {

                    var faceArray = faces[i];

                    indices.push(faceArray[0],faceArray[1],faceArray[2])
    
                }

                geometry.setIndex( indices );
				geometry.setAttribute( 'position', new THREE.Float32BufferAttribute( bufferGeoVertices, 3 ) );

                material = new THREE.MeshPhongMaterial({ color: 0xffffff, flatShading: true });
                mesh = new THREE.Mesh( geometry, material );
                mesh.position.Y= 10000;
                scene.add( mesh );
            
            }

            if(nodes.length>1){
   
              nodes.forEach(node => {

               var valueJson =  node.value;

               var value = JSON.parse(valueJson);
                
             });
           }

            console.log(json)



        }
    }

    function initRenderer(){

        renderer = new THREE.WebGLRenderer( { antialias: true } );
        renderer.setClearColor( 0xffffff, 0 );
		renderer.setPixelRatio( window.devicePixelRatio );
		renderer.setSize( window.innerWidth, window.innerHeight );
		document.body.appendChild( renderer.domElement );

    }

    function initLights(){

    
        const dirLight1 = new THREE.DirectionalLight(0xffddcc, 1);
        dirLight1.position.set(1, 0.75, 0.5);
        scene.add(dirLight1);

        const dirLight2 = new THREE.DirectionalLight(0xccccff, 1);
        dirLight2.position.set(- 1, 0.75, - 0.5);
        scene.add(dirLight2);

        const ambientLight = new THREE.AmbientLight( 0x222222 );
				scene.add( ambientLight );

    }

    function initControls(){

        controls = new OrbitControls(camera,renderer.domElement) 
        controls.enablePan = true;
		controls.enableZoom = true;
        controls.enableDamping = true;
		controls.dampingFactor = 0.1;

    }

    function createTorus(){

        const geometry = new THREE.TorusKnotGeometry( 10, 3, 100, 16 );
        
        material = new THREE.MeshPhongMaterial({ color: 0xffffff, flatShading: true });

        mesh = new THREE.Mesh( geometry, material );
        mesh.position.Y= 10000;
        scene.add( mesh );

    }

    function resize() {

        const width = window.innerWidth;
        const height = window.innerHeight;

        camera.aspect = width / height;
        camera.updateProjectionMatrix();

        renderer.setSize( width, height );

    }

    function animation( ) {

    requestAnimationFrame(animation);

    //mesh.rotation.x  +=0.01;
   // mesh.rotation.y +=0.01;

    controls.update();

    renderer.render( scene, camera );

    }


      </script>   
</body>
</html>